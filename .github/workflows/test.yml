name: Test Dotfiles

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check all shell scripts
        run: |
          find . -name "*.sh" -type f | while read -r file; do
            bash -n "$file" || exit 1
          done
          bash -n ./ctdev || exit 1

  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck on lib/
        run: shellcheck lib/*.sh

      - name: Run ShellCheck on cmds/
        run: shellcheck cmds/*.sh

      - name: Run ShellCheck on ctdev
        run: shellcheck ./ctdev

      - name: Run ShellCheck on component installers
        run: |
          shellcheck components/*/install.sh
          shellcheck components/cli/*.sh

  test-cli:
    name: Test ctdev CLI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test --help flag
        run: ./ctdev --help

      - name: Test --version flag
        run: ./ctdev --version

      - name: Test list command
        run: ./ctdev list

      - name: Test info command
        run: ./ctdev info

      - name: Test dry-run install
        run: ./ctdev --dry-run install

      - name: Test dry-run install with --skip-system
        run: ./ctdev --dry-run install --skip-system

  test-ubuntu:
    name: Test on Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu-version: ['22.04', '24.04']
      fail-fast: false

    container:
      image: ubuntu:${{ matrix.ubuntu-version }}

    steps:
      - name: Install git
        run: |
          apt-get update
          apt-get install -y git sudo curl

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install zsh component
        run: ./ctdev install zsh

      - name: Verify zsh installation
        run: |
          command -v zsh || exit 1
          [ -d ~/.oh-my-zsh ] || exit 1
          [ -d ~/.zsh/pure ] || exit 1

      - name: Verify config files
        run: |
          [ -f ~/.zshrc ] || exit 1
          [ -f ~/.oh-my-zsh/custom/aliases.zsh ] || exit 1
          [ -f ~/.oh-my-zsh/custom/exports.zsh ] || exit 1

      - name: Install git component
        run: ./components/git/install.sh --name "CI Test" --email "ci@test.com"

      - name: Verify git config
        run: |
          [ -f ~/.gitconfig ] || exit 1
          [ -f ~/.gitignore ] || exit 1
          [ -f ~/.gitconfig.local ] || exit 1

      - name: Install CLI tools
        run: ./ctdev install cli

      - name: Verify CLI tools
        run: |
          command -v jq || exit 1
          command -v gh || exit 1

      - name: Run info check
        run: ./ctdev info

  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test CLI commands
        run: |
          ./ctdev --version
          ./ctdev list
          ./ctdev info

      - name: Test dry-run install
        run: ./ctdev --dry-run install

      - name: Install zsh component
        run: ./ctdev install zsh

      - name: Verify zsh installation
        run: |
          [ -d ~/.oh-my-zsh ] || exit 1
          [ -d ~/.zsh/pure ] || exit 1
          [ -f ~/.zshrc ] || exit 1

      - name: Install git component
        run: ./components/git/install.sh --name "CI Test" --email "ci@test.com"

      - name: Verify git config
        run: |
          [ -f ~/.gitconfig ] || exit 1
          [ -f ~/.gitconfig.local ] || exit 1
